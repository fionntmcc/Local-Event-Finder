<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>
      Local Events
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- Search Bar with embedded button -->
  <div class="search-container">
    <div class="search-wrapper">
      <ion-searchbar 
        [(ngModel)]="searchTerm" 
        (ionChange)="searchEvents()"
        placeholder="Search events, categories or places"
        animated
        debounce="300"
        show-clear-button="always">
      </ion-searchbar>
      
      <ion-button class="category-filter-btn" id="category-filter-btn" fill="clear">
        Filter
      </ion-button>
    </div>
    
    <ion-chip *ngIf="searchTerm" (click)="clearSearch()" color="medium">
      <ion-label>Clear</ion-label>
    </ion-chip>
  </div>

  <!-- Category Filter Popover -->
  <ion-popover trigger="category-filter-btn" [dismissOnSelect]="false" side="bottom">
    <ng-template>
      <ion-content>
        <ion-list lines="full">
          <ion-list-header>
            <ion-label>Event Categories</ion-label>
          </ion-list-header>
          <ion-item *ngFor="let category of categories">
            <ion-checkbox [value]="category" labelPlacement="end">{{ category | titlecase }}</ion-checkbox>
          </ion-item>
        </ion-list>
        <div class="popover-footer">
          <ion-button fill="outline" size="small" (click)="applyFilters()">Clear All</ion-button>
          <ion-button (click)="applyFilters()">Apply</ion-button>
        </div>
      </ion-content>
    </ng-template>
  </ion-popover>

  <!-- Map Section -->
  <div class="map-container">
    <div id="map" class="map-canvas"></div>
  </div>

  <div *ngIf="events.length === 0 && !error && !isLoading" class="ion-text-center ion-padding">
    <ion-text>
      <p>No events found nearby. Try adjusting your search.</p>
    </ion-text>
  </div>

  <div *ngIf="isLoading" class="ion-text-center ion-padding">
    <ion-spinner name="circular"></ion-spinner>
    <ion-text>
      <p>Loading events...</p>
    </ion-text>
  </div>

  <div *ngIf="error" class="ion-text-center ion-padding">
    <ion-text color="danger">
      <p>{{ error }}</p>\
    </ion-text>
  </div>

  <!-- Display filtered events if search is active, otherwise display all events -->
  <ion-list *ngIf="events.length > 0">
    <ion-card *ngFor="let event of events" class="event-card" [routerLink]="['/event', event.id]">
      <div class="event-background" [ngStyle]="{'background-image': 'linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.8)), url(https://source.unsplash.com/400x200/photos/random/?event)'}">
        <ion-card-header>
          <ion-chip *ngIf="event.category" class="category-chip">
            {{ event.category | titlecase }}
          </ion-chip>
          <ion-card-title class="event-title">{{ event.title }}</ion-card-title>
        </ion-card-header>
        
        <ion-card-content class="event-content">
          <div class="event-details">
            <div class="event-info">
              <!-- <ion-icon name="calendar-outline"></ion-icon> -->
              <span>{{ formatDate(event.start_local) }}</span>
            </div>
            
            <div class="event-info" *ngIf="event.location && event.location.length >= 2">
              <!-- <ion-icon name="location-outline"></ion-icon> -->
              <span>{{ getDistance(event.location[1], event.location[0]) }} away</span>
            </div>
            
            <div class="event-info" *ngIf="event.predicted_event_spend > 0">
              <!-- <ion-icon name="wallet-outline"></ion-icon> -->
              <span>Est. cost: {{ formatCurrency(event.predicted_event_spend) }}</span>
            </div>
          </div>
          
          <div class="event-description" *ngIf="event.description">
            <p>{{ truncateDescription(event.description, 120) }}</p>
          </div>
          
          <div class="event-labels" *ngIf="event.labels && event.labels.length > 0">
            <ion-chip *ngFor="let label of getLimitedLabels(event.labels, 3)" class="small-chip">
              {{ label }}
            </ion-chip>
          </div>
        </ion-card-content>
      </div>
    </ion-card>
  </ion-list>

  <ion-infinite-scroll (ionInfinite)="loadMoreEvents($event)" *ngIf="!searchTerm">
    <ion-infinite-scroll-content loadingText="Loading more events..."></ion-infinite-scroll-content>
  </ion-infinite-scroll>
</ion-content>